"""pandas Part-4 ç¤ºä¾‹æ¼”ç¤º

è¯¥è„šæœ¬æ¼”ç¤ºäº† Pandas åœ¨æ•°æ®ç´¢å¼•ã€å­é›†é€‰æ‹©ã€å¸ƒå°”è¿‡æ»¤ã€
æ—¶é—´åºåˆ—è®¡ç®—ç­‰å¸¸ç”¨æ“ä½œçš„ç”¨æ³•ï¼Œä»£ç å–æè‡ª
https://wqu.guru/blog/quantopia-quantitative-analysis-56-lectures/introduction-to-pandas-part-4
ä¸­çš„æ¡ˆä¾‹ï¼Œå¹¶åœ¨å…³é”®æ­¥éª¤è¡¥å……äº†åº•å±‚å…¬å¼è§£é‡Šã€‚

è¿è¡Œæ–¹å¼ï¼š
    uv -m quant.pandas_demo.part4_demo

é€‚åˆåˆå­¦è€…ï¼šæœ¬æ–‡æ¡£ä»åŸºç¡€æ¦‚å¿µå¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°é«˜çº§åº”ç”¨
å»ºè®®å­¦ä¹ é¡ºåºï¼š
1. å…ˆç†è§£ Series å’Œ DataFrame çš„åŸºæœ¬æ¦‚å¿µ
2. æŒæ¡ç´¢å¼•å’Œåˆ‡ç‰‡æ“ä½œ
3. å­¦ä¹ ç¼ºå¤±å€¼å¤„ç†
4. äº†è§£æ—¶é—´åºåˆ—æ“ä½œ
5. æœ€åå­¦ä¹ æ»šåŠ¨çª—å£ç­‰é«˜çº§åŠŸèƒ½
"""

import numpy as np
import pandas as pd

# --------------------------- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µå’Œæ•°æ®åˆ›å»º ---------------------------

print("=" * 60)
print("ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µå’Œæ•°æ®åˆ›å»º")
print("=" * 60)

# ä»€ä¹ˆæ˜¯ Seriesï¼Ÿ
# Series æ˜¯ pandas çš„ä¸€ç»´æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äº Excel ä¸­çš„ä¸€åˆ—æ•°æ®
# å®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæ•°æ®å€¼ï¼ˆvaluesï¼‰å’Œç´¢å¼•ï¼ˆindexï¼‰
# å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªå¸¦æ ‡ç­¾çš„æ•°ç»„

# ä»åˆ—è¡¨åˆ›å»º Series - æœ€ç®€å•çš„æ–¹å¼
print("\n1. åˆ›å»ºç®€å•çš„ Series")
print("-" * 30)

# pandas.Series åº•å±‚ä½¿ç”¨ NumPy ndarray å­˜å‚¨æ•°æ®ï¼Œæä¾›æ ‡ç­¾åŒ–çš„ä¸€ç»´æ•°ç»„
s = pd.Series([1, 2, np.nan, 4, 5, 6, 7, 8, 9, 10], name="Toy Series")
print("åŸå§‹ Seriesï¼š")
print(s)
print(f"æ•°æ®ç±»å‹ï¼š{s.dtype}")  # æ˜¾ç¤ºæ•°æ®ç±»å‹ï¼Œé€šå¸¸æ˜¯ float64
print(f"é•¿åº¦ï¼š{len(s)}")  # æ˜¾ç¤ºæ•°æ®é•¿åº¦
print(f"ç´¢å¼•ï¼š{s.index}")  # æ˜¾ç¤ºç´¢å¼•ï¼Œé»˜è®¤æ˜¯ 0,1,2...

# æ³¨æ„ï¼šnp.nan è¡¨ç¤ºç¼ºå¤±å€¼ï¼ˆNot a Numberï¼‰ï¼Œåœ¨é‡‘èæ•°æ®ä¸­å¾ˆå¸¸è§
# æ¯”å¦‚æŸå¤©è‚¡å¸‚ä¼‘å¸‚ï¼Œå°±æ²¡æœ‰ä»·æ ¼æ•°æ®

print("\n2. è®¾ç½®æ—¶é—´ç´¢å¼•")
print("-" * 30)

# æ—¶é—´ç´¢å¼•æ˜¯é‡‘èæ•°æ®åˆ†æçš„æ ¸å¿ƒæ¦‚å¿µ
# pd.date_range ç”Ÿæˆè¿ç»­çš„æ—¥æœŸåºåˆ—ï¼Œå°±åƒæ—¥å†ä¸€æ ·
# freq="D" è¡¨ç¤ºæ¯æ—¥é¢‘ç‡ï¼ˆDailyï¼‰ï¼Œè¿˜å¯ä»¥ç”¨ "H"ï¼ˆå°æ—¶ï¼‰ã€"M"ï¼ˆåˆ†é’Ÿï¼‰ç­‰
# periods=10 ç”Ÿæˆ 10 ä¸ªè¿ç»­æ—¥æœŸ
date_index = pd.date_range("2025-01-01", periods=10, freq="D")
print("ç”Ÿæˆçš„æ—¥æœŸç´¢å¼•ï¼š")
print(date_index)

# å°†æ—¥æœŸç´¢å¼•èµ‹ç»™ Series
s.index = date_index
print("\nå¸¦æ—¶é—´ç´¢å¼•çš„ Seriesï¼š")
print(s)

# ç°åœ¨æ¯ä¸ªæ•°æ®ç‚¹éƒ½æœ‰äº†å¯¹åº”çš„æ—¥æœŸæ ‡ç­¾ï¼Œå°±åƒè‚¡ç¥¨çš„æ¯æ—¥æ”¶ç›˜ä»·ä¸€æ ·

# --------------------------- ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®è®¿é—®å’Œåˆ‡ç‰‡ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®è®¿é—®å’Œåˆ‡ç‰‡")
print("=" * 60)

print("\n1. iloc - åŸºäºä½ç½®çš„ç´¢å¼•ï¼ˆç±»ä¼¼æ•°ç»„ä¸‹æ ‡ï¼‰")
print("-" * 40)

# iloc åŸºäºæ•´æ•°ä½ç½®çš„ç´¢å¼•ï¼Œåº•å±‚ç›´æ¥è®¿é—® ndarray çš„æŒ‡å®šä½ç½®
# å°±åƒè®¿é—®åˆ—è¡¨å…ƒç´ ä¸€æ ·ï¼šlist[0] è·å–ç¬¬ä¸€ä¸ªå…ƒç´ 
print("ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆä½ç½®0ï¼‰ï¼š", s.iloc[0])  # ç»“æœï¼š1.0
print("æœ€åä¸€ä¸ªå…ƒç´ ï¼š", s.iloc[-1])  # ç»“æœï¼š10.0

# iloc åˆ‡ç‰‡æ“ä½œï¼šs.iloc[1:4] è¿”å›ä½ç½® 1,2,3 çš„å…ƒç´ ï¼ˆä¸åŒ…æ‹¬ä½ç½® 4ï¼‰
# è¿™å’Œ Python åˆ—è¡¨åˆ‡ç‰‡è§„åˆ™å®Œå…¨ä¸€æ ·
print("ä½ç½®1åˆ°3çš„å…ƒç´ ï¼š")
print(s.iloc[1:4])
# è¾“å‡ºï¼š
# 2025-01-02    2.0
# 2025-01-03    NaN
# 2025-01-04    4.0

print("\n2. loc - åŸºäºæ ‡ç­¾çš„ç´¢å¼•ï¼ˆä½¿ç”¨æ—¥æœŸæ ‡ç­¾ï¼‰")
print("-" * 40)

# loc åŸºäºæ ‡ç­¾çš„ç´¢å¼•ï¼Œé€šè¿‡æ—¥æœŸæ ‡ç­¾å®šä½æ•°æ®
# åœ¨é‡‘èåˆ†æä¸­æ›´å¸¸ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸å…³å¿ƒ"æŸä¸ªå…·ä½“æ—¥æœŸ"çš„æ•°æ®
print("2025å¹´1æœˆ2æ—¥çš„å€¼ï¼š", s.loc["2025-01-02"])  # ç»“æœï¼š2.0

# loc åˆ‡ç‰‡ï¼šåŒ…å«èµ·å§‹å’Œç»“æŸæ ‡ç­¾çš„æ‰€æœ‰æ•°æ®
# æ³¨æ„ï¼šä¸ iloc ä¸åŒï¼Œloc åˆ‡ç‰‡æ˜¯åŒ…å«ç»“æŸæ ‡ç­¾çš„
print("2025-01-02 åˆ° 2025-01-04 çš„æ•°æ®ï¼š")
print(s.loc["2025-01-02":"2025-01-04"])
# è¾“å‡ºï¼š
# 2025-01-02    2.0
# 2025-01-03    NaN
# 2025-01-04    4.0

# å°æŠ€å·§ï¼šè®°å¿†æ–¹æ³•
# ilocï¼ši = integerï¼ˆæ•´æ•°ï¼‰ï¼Œç”¨æ•°å­—ä½ç½®
# locï¼šl = labelï¼ˆæ ‡ç­¾ï¼‰ï¼Œç”¨æ ‡ç­¾åç§°

# --------------------------- ç¬¬ä¸‰éƒ¨åˆ†ï¼šç¼ºå¤±å€¼å¤„ç† ---------------------------

print("\n" + "=" * 60)
print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šç¼ºå¤±å€¼å¤„ç†")
print("=" * 60)

print("\n1. æ£€æŸ¥ç¼ºå¤±å€¼")
print("-" * 20)

# åœ¨çœŸå®æ•°æ®ä¸­ï¼Œç¼ºå¤±å€¼å¾ˆå¸¸è§ï¼šåœç‰Œè‚¡ç¥¨ã€èŠ‚å‡æ—¥ã€æ•°æ®é”™è¯¯ç­‰
print("æ˜¯å¦æœ‰ç¼ºå¤±å€¼ï¼š", s.isnull().any())  # True è¡¨ç¤ºæœ‰ç¼ºå¤±å€¼
print("ç¼ºå¤±å€¼ä¸ªæ•°ï¼š", s.isnull().sum())  # ç»Ÿè®¡ç¼ºå¤±å€¼æ•°é‡
print("ç¼ºå¤±å€¼ä½ç½®ï¼š")
print(s.isnull())  # æ˜¾ç¤ºæ¯ä¸ªä½ç½®æ˜¯å¦ä¸ºç¼ºå¤±å€¼

print("\n2. å¡«å……ç¼ºå¤±å€¼ - fillna() æ–¹æ³•")
print("-" * 30)

# fillna() å¡«å……ç¼ºå¤±å€¼ï¼Œæœ‰å¤šç§ç­–ç•¥ï¼š
# 1. ç”¨å‡å€¼å¡«å……ï¼ˆé€‚åˆæ•°å€¼æ•°æ®ï¼‰
print("åŸå§‹æ•°æ®çš„å‡å€¼ï¼š", s.mean())  # è‡ªåŠ¨å¿½ç•¥ NaN è®¡ç®—å‡å€¼

# s.mean() è®¡ç®—å‡å€¼æ—¶è‡ªåŠ¨å¿½ç•¥ NaN å€¼
# åº•å±‚é€»è¾‘ï¼šå¯¹äºæ¯ä¸ª NaN ä½ç½®ï¼Œç”¨è®¡ç®—å¾—åˆ°çš„å‡å€¼æ›¿æ¢
s_filled = s.fillna(s.mean())
print("ç”¨å‡å€¼å¡«å……åï¼š")
print(s_filled)

# å…¶ä»–å¡«å……æ–¹æ³•ç¤ºä¾‹ï¼š
print("\nå…¶ä»–å¸¸ç”¨å¡«å……æ–¹æ³•ï¼š")
print("å‘å‰å¡«å……ï¼ˆç”¨å‰ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼‰ï¼š")
print(s.fillna(method="ffill"))  # forward fill

print("å‘åå¡«å……ï¼ˆç”¨åä¸€ä¸ªæœ‰æ•ˆå€¼ï¼‰ï¼š")
print(s.fillna(method="bfill"))  # backward fill

print("ç”¨å›ºå®šå€¼å¡«å……ï¼š")
print(s.fillna(0))  # ç”¨ 0 å¡«å……

print("\n3. åˆ é™¤ç¼ºå¤±å€¼ - dropna() æ–¹æ³•")
print("-" * 30)

# dropna() åˆ é™¤åŒ…å«ç¼ºå¤±å€¼çš„è¡Œ/åˆ—
# åº•å±‚é€»è¾‘ï¼šåˆ›å»ºå¸ƒå°”æ©ç ï¼Œæ ‡è®°é NaN ä½ç½®ï¼Œè¿”å›è¿‡æ»¤åçš„æ•°æ®
s_dropped = s.dropna()
print("åˆ é™¤ç¼ºå¤±å€¼åï¼š")
print(s_dropped)
print(f"åŸå§‹é•¿åº¦ï¼š{len(s)}ï¼Œåˆ é™¤åé•¿åº¦ï¼š{len(s_dropped)}")

# æ³¨æ„ï¼šåˆ é™¤æ•°æ®ä¼šæ°¸ä¹…ä¸¢å¤±ä¿¡æ¯ï¼Œå¡«å……æ•°æ®å¯èƒ½å¼•å…¥åå·®
# é€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºå…·ä½“ä¸šåŠ¡åœºæ™¯

# --------------------------- ç¬¬å››éƒ¨åˆ†ï¼šæ—¶é—´åºåˆ—æ“ä½œ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬å››éƒ¨åˆ†ï¼šæ—¶é—´åºåˆ—æ“ä½œ")
print("=" * 60)

print("\n1. é‡é‡‡æ · - resample() æ–¹æ³•")
print("-" * 30)

# æ—¶é—´åºåˆ—é‡é‡‡æ · - resample() æŒ‰æŒ‡å®šé¢‘ç‡é‡æ–°ç»„ç»‡æ•°æ®
# å°±åƒæŠŠæ—¥æ•°æ®æ±‡æ€»æˆæœˆæ•°æ®ï¼Œæˆ–è€…æŠŠåˆ†é’Ÿæ•°æ®æ±‡æ€»æˆå°æ—¶æ•°æ®

# "ME" è¡¨ç¤ºæŒ‰æœˆæœ«é‡é‡‡æ ·ï¼ˆMonth Endï¼Œæ›¿ä»£å·²å¼ƒç”¨çš„"M"ï¼‰
# mean() å¯¹æ¯æœˆçš„æ•°æ®è®¡ç®—å¹³å‡å€¼
# åº•å±‚é€»è¾‘ï¼šæ ¹æ®æ—¶é—´ç´¢å¼•å°†æ•°æ®åˆ†ç»„ï¼Œå¯¹æ¯ç»„åº”ç”¨èšåˆå‡½æ•°
monthly_data = s.resample("ME").mean()
print("æŒ‰æœˆé‡é‡‡æ ·ï¼ˆæœˆå¹³å‡å€¼ï¼‰ï¼š")
print(monthly_data)

# å…¶ä»–é‡é‡‡æ ·é¢‘ç‡ç¤ºä¾‹ï¼š
print("æŒ‰å‘¨é‡é‡‡æ ·ï¼š")
print(s.resample("W").mean())

# é‡é‡‡æ ·çš„é‡‘èåº”ç”¨ï¼š
# - æ—¥æ•°æ® â†’ å‘¨æ•°æ®ï¼šè®¡ç®—å‘¨æ”¶ç›Šç‡
# - åˆ†é’Ÿæ•°æ® â†’ æ—¥æ•°æ®ï¼šè®¡ç®—æ—¥å†…æ³¢åŠ¨
# - å°æ—¶æ•°æ® â†’ 4å°æ—¶æ•°æ®ï¼šå¤šæ—¶é—´æ¡†æ¶åˆ†æ

print("\n2. æ—¶åŒºå¤„ç†")
print("-" * 20)

# å…¨çƒé‡‘èå¸‚åœºæ¶‰åŠå¤šä¸ªæ—¶åŒºï¼Œæ—¶åŒºå¤„ç†å¾ˆé‡è¦
print("åŸå§‹æ•°æ®ï¼ˆæ— æ—¶åŒºï¼‰ï¼š")
print(s.index)

# tz_localize() ä¸ºæ— æ—¶åŒºæ•°æ®æ·»åŠ æ—¶åŒºä¿¡æ¯
# å°±åƒç»™æ•°æ®è´´ä¸Š"è¿™æ˜¯UTCæ—¶é—´"çš„æ ‡ç­¾
s_utc = s.tz_localize("UTC")
print("æœ¬åœ°åŒ–ä¸ºUTCæ—¶åŒºåï¼š")
print(s_utc.index)

# tz_convert() åœ¨å·²æœ‰æ—¶åŒºæ•°æ®é—´è¿›è¡Œè½¬æ¢
# å°±åƒæŠŠUTCæ—¶é—´è½¬æ¢æˆçº½çº¦æ—¶é—´
s_eastern = s_utc.tz_convert("US/Eastern")
print("è½¬æ¢ä¸ºç¾ä¸œæ—¶åŒºåï¼š")
print(s_eastern.index)

# å®é™…åº”ç”¨ï¼šå¦‚æœä½ åœ¨ä¸­å›½åˆ†æç¾è‚¡ï¼Œéœ€è¦å¤„ç†æ—¶åŒºå·®å¼‚

# --------------------------- ç¬¬äº”éƒ¨åˆ†ï¼šDataFrame æ“ä½œ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬äº”éƒ¨åˆ†ï¼šDataFrame æ“ä½œ")
print("=" * 60)

print("\n1. åˆ›å»º DataFrame")
print("-" * 20)

# DataFrame æ˜¯ä»€ä¹ˆï¼Ÿ
# DataFrame æ˜¯äºŒç»´æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äº Excel è¡¨æ ¼æˆ–æ•°æ®åº“è¡¨
# å¯ä»¥çœ‹ä½œæ˜¯å¤šä¸ª Series çš„é›†åˆï¼Œæ¯åˆ—æ˜¯ä¸€ä¸ª Seriesï¼Œå…±äº«è¡Œç´¢å¼•

# DataFrame åˆ›å»º - åº•å±‚ä¸ºå¤šä¸ª Series çš„é›†åˆï¼Œå…±äº«è¡Œç´¢å¼•
data = {
    "A": np.random.randn(5),  # æ ‡å‡†æ­£æ€åˆ†å¸ƒéšæœºæ•°ï¼ˆæ¨¡æ‹Ÿè‚¡ç¥¨æ”¶ç›Šç‡ï¼‰
    "B": ["X", "Y", "Z", "W", "V"],  # å­—ç¬¦ä¸²æ•°æ®ï¼ˆæ¨¡æ‹Ÿè‚¡ç¥¨ä»£ç ï¼‰
    "C": pd.date_range("2025-01-01", periods=5),  # æ—¥æœŸåºåˆ—
}
df = pd.DataFrame(data)
print("åˆ›å»ºçš„ DataFrameï¼š")
print(df)
print(f"å½¢çŠ¶ï¼ˆè¡Œæ•°ï¼Œåˆ—æ•°ï¼‰ï¼š{df.shape}")
print(f"åˆ—åï¼š{df.columns.tolist()}")
print(f"æ•°æ®ç±»å‹ï¼š\n{df.dtypes}")

print("\n2. æ·»åŠ å’Œåˆ é™¤åˆ—")
print("-" * 20)

# æ–°å¢è®¡ç®—åˆ— - å‘é‡åŒ–æ“ä½œï¼Œåº•å±‚ä½¿ç”¨ NumPy çš„å¹¿æ’­æœºåˆ¶
# df["A"] * 2 å¯¹æ•´åˆ—è¿›è¡Œæ ‡é‡ä¹˜æ³•ï¼Œæ¯” for å¾ªç¯å¿«æ•°ç™¾å€
print("æ·»åŠ è®¡ç®—åˆ— D = A * 2ï¼š")
df["D"] = df["A"] * 2
print(df[["A", "D"]])  # åªæ˜¾ç¤ºç›¸å…³åˆ—

# æ›´å¤šè®¡ç®—åˆ—ç¤ºä¾‹ï¼š
df["A_squared"] = df["A"] ** 2  # å¹³æ–¹
df["A_abs"] = df["A"].abs()  # ç»å¯¹å€¼
print("æ·»åŠ æ›´å¤šè®¡ç®—åˆ—åï¼š")
print(df[["A", "A_squared", "A_abs"]])

# åˆ é™¤åˆ— - axis=1 è¡¨ç¤ºæŒ‰åˆ—åˆ é™¤ï¼ˆaxis=0 ä¸ºæŒ‰è¡Œåˆ é™¤ï¼‰
print("\nåˆ é™¤åˆ— B å’Œå¤šä½™çš„è®¡ç®—åˆ—ï¼š")
df = df.drop(["B", "A_squared", "A_abs"], axis=1)
print(df)

# è®°å¿†æŠ€å·§ï¼šaxis=0 æƒ³è±¡æˆå‚ç›´æ–¹å‘ï¼ˆè¡Œï¼‰ï¼Œaxis=1 æƒ³è±¡æˆæ°´å¹³æ–¹å‘ï¼ˆåˆ—ï¼‰

print("\n3. æ•°æ®ç­›é€‰å’Œå¸ƒå°”ç´¢å¼•")
print("-" * 25)

# å¸ƒå°”ç´¢å¼• - åˆ›å»ºå¸ƒå°”æ©ç è¿›è¡Œæ•°æ®ç­›é€‰
# è¿™æ˜¯æ•°æ®åˆ†æä¸­æœ€é‡è¦çš„æŠ€èƒ½ä¹‹ä¸€

# ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ¡ä»¶
condition = df["A"] > 0
print("æ¡ä»¶ 'A > 0' çš„ç»“æœï¼š")
print(condition)  # True/False çš„ Series

# ç¬¬äºŒæ­¥ï¼šåº”ç”¨æ¡ä»¶ç­›é€‰
# df["A"] > 0 ç”Ÿæˆå¸ƒå°” Seriesï¼ŒTrue å¯¹åº”ä¿ç•™çš„è¡Œ
filtered = df[condition]
print("ç­›é€‰ A åˆ—æ­£å€¼çš„è¡Œï¼š")
print(filtered)

# å¤æ‚æ¡ä»¶ç¤ºä¾‹ï¼š
print("\nå¤æ‚ç­›é€‰æ¡ä»¶ç¤ºä¾‹ï¼š")
# å¤šæ¡ä»¶ç»„åˆï¼ˆæ³¨æ„ä½¿ç”¨æ‹¬å·å’Œ &ã€| è¿ç®—ç¬¦ï¼‰
complex_filter = df[(df["A"] > 0) & (df["D"] < 1)]
print("A > 0 ä¸” D < 1 çš„è¡Œï¼š")
print(complex_filter)

# å¸¸ç”¨ç­›é€‰æ¨¡å¼ï¼š
print("å…¶ä»–å¸¸ç”¨ç­›é€‰ï¼š")
print("Aåˆ—æœ€å¤§å€¼æ‰€åœ¨è¡Œï¼š")
print(df[df["A"] == df["A"].max()])

print("Aåˆ—å‰50%çš„è¡Œï¼š")
print(df[df["A"] > df["A"].median()])

# --------------------------- ç¬¬å…­éƒ¨åˆ†ï¼šæ•°æ®åˆå¹¶å’Œè¿æ¥ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬å…­éƒ¨åˆ†ï¼šæ•°æ®åˆå¹¶å’Œè¿æ¥")
print("=" * 60)

print("\n1. ç®€å•è¿æ¥ - concat()")
print("-" * 25)

# DataFrame åˆå¹¶ - concat() æ²¿æŒ‡å®šè½´è¿æ¥å¤šä¸ªå¯¹è±¡
# å°±åƒæŠŠä¸¤å¼ è¡¨æ ¼æ‹¼æ¥åœ¨ä¸€èµ·
df1 = pd.DataFrame({"X": [1, 2], "Y": [3, 4]})
df2 = pd.DataFrame({"X": [5, 6], "Y": [7, 8]})

print("ç¬¬ä¸€ä¸ª DataFrameï¼š")
print(df1)
print("ç¬¬äºŒä¸ª DataFrameï¼š")
print(df2)

# é»˜è®¤ axis=0ï¼ˆæŒ‰è¡Œè¿æ¥ï¼‰ï¼Œignore_index=False ä¿ç•™åŸç´¢å¼•
combined = pd.concat([df1, df2])
print("å‚ç›´è¿æ¥ç»“æœï¼ˆaxis=0ï¼‰ï¼š")
print(combined)

# æ°´å¹³è¿æ¥
combined_horizontal = pd.concat([df1, df2], axis=1)
print("æ°´å¹³è¿æ¥ç»“æœï¼ˆaxis=1ï¼‰ï¼š")
print(combined_horizontal)

# é‡ç½®ç´¢å¼•
combined_reset = pd.concat([df1, df2], ignore_index=True)
print("è¿æ¥åé‡ç½®ç´¢å¼•ï¼š")
print(combined_reset)

# å®é™…åº”ç”¨ï¼šåˆå¹¶ä¸åŒæ¥æºçš„è‚¡ç¥¨æ•°æ®ã€æ‹¼æ¥å†å²æ•°æ®ç­‰

# --------------------------- ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ»šåŠ¨çª—å£è®¡ç®— ---------------------------

print("\n" + "=" * 60)
print("ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ»šåŠ¨çª—å£è®¡ç®—ï¼ˆé‡è¦ï¼ï¼‰")
print("=" * 60)

print("\n1. åŸºç¡€æ»šåŠ¨çª—å£æ¦‚å¿µ")
print("-" * 25)

# ä»€ä¹ˆæ˜¯æ»šåŠ¨çª—å£ï¼Ÿ
# æƒ³è±¡ä¸€ä¸ªå›ºå®šå¤§å°çš„"çª—å£"åœ¨æ•°æ®ä¸Šç§»åŠ¨ï¼Œæ¯æ¬¡è®¡ç®—çª—å£å†…çš„ç»Ÿè®¡å€¼
# æ¯”å¦‚ï¼š30æ—¥ç§»åŠ¨å¹³å‡çº¿å°±æ˜¯ä¸€ä¸ª30å¤©çš„æ»šåŠ¨çª—å£

# åˆ›å»ºæ›´é•¿çš„æ—¶é—´åºåˆ—ç”¨äºæ¼”ç¤º
np.random.seed(42)  # è®¾ç½®éšæœºç§å­ç¡®ä¿ç»“æœå¯é‡ç°
long_series = pd.Series(
    np.random.normal(0, 1, 50),  # 50ä¸ªæ•°æ®ç‚¹
    index=pd.date_range("2025-01-01", periods=50, freq="D"),
)

print("åŸå§‹æ•°æ®ï¼ˆå‰10ä¸ªï¼‰ï¼š")
print(long_series.head(10))

# æ»šåŠ¨çª—å£è®¡ç®— - rolling() åˆ›å»ºæ»‘åŠ¨çª—å£å¯¹è±¡
# window=5 è¡¨ç¤º 5 æœŸçª—å£ï¼Œæ¯æ¬¡è®¡ç®—ä½¿ç”¨æœ€è¿‘ 5 ä¸ªæ•°æ®ç‚¹
print("\n5æ—¥æ»šåŠ¨å¹³å‡ï¼š")
rolling_5 = long_series.rolling(5).mean()
print(rolling_5.head(10))

# æ³¨æ„ï¼šå‰4ä¸ªå€¼æ˜¯NaNï¼Œå› ä¸ºä¸è¶³5ä¸ªæ•°æ®ç‚¹æ— æ³•è®¡ç®—

# æ»šåŠ¨å‡å€¼å…¬å¼ï¼šMA_t = (X_t + X_{t-1} + ... + X_{t-4}) / 5
# é‡‘èæ„ä¹‰ï¼šå¹³æ»‘ä»·æ ¼æ³¢åŠ¨ï¼Œè¯†åˆ«è¶‹åŠ¿

print("\n2. æ»šåŠ¨ç»Ÿè®¡æŒ‡æ ‡")
print("-" * 20)

# æ»šåŠ¨æ ‡å‡†å·® - è¡¡é‡æ³¢åŠ¨æ€§
# æ»šåŠ¨æ ‡å‡†å·®å…¬å¼ï¼šÏƒ_t = sqrt(Î£(X_i - MA_t)Â² / (n-1))ï¼Œå…¶ä¸­ i ä» t-4 åˆ° t
rolling_std = long_series.rolling(5).std()
print("5æ—¥æ»šåŠ¨æ ‡å‡†å·®ï¼ˆå‰10ä¸ªï¼‰ï¼š")
print(rolling_std.head(10))

# å…¶ä»–æœ‰ç”¨çš„æ»šåŠ¨ç»Ÿè®¡ï¼š
print("5æ—¥æ»šåŠ¨æœ€å¤§å€¼ï¼š")
print(long_series.rolling(5).max().head(10))

print("5æ—¥æ»šåŠ¨æœ€å°å€¼ï¼š")
print(long_series.rolling(5).min().head(10))

# min_periods å‚æ•° - è®¾ç½®è®¡ç®—æ‰€éœ€çš„æœ€å°è§‚æµ‹æ•°
print("\nä½¿ç”¨ min_periods=1ï¼š")
# min_periods=1 è¡¨ç¤ºå³ä½¿æ•°æ®ä¸è¶³çª—å£å¤§å°ä¹Ÿè¿›è¡Œè®¡ç®—
# é‡‘èæ„ä¹‰ï¼šåœ¨æ•°æ®åˆæœŸå°±èƒ½æä¾›æŒ‡æ ‡å€¼ï¼Œé¿å…è¿‡å¤šçš„ç¼ºå¤±å€¼
rolling_min_periods = long_series.rolling(5, min_periods=1).mean()
print(rolling_min_periods.head(10))
# ç°åœ¨ç¬¬ä¸€ä¸ªå€¼å°±ä¸æ˜¯NaNäº†

# --------------------------- ç¬¬å…«éƒ¨åˆ†ï¼šæ”¶ç›Šç‡è®¡ç®— ---------------------------

print("\n" + "=" * 60)
print("ç¬¬å…«éƒ¨åˆ†ï¼šæ”¶ç›Šç‡è®¡ç®—ï¼ˆé‡‘èæ ¸å¿ƒï¼‰")
print("=" * 60)

print("\n1. åŸºç¡€æ”¶ç›Šç‡æ¦‚å¿µ")
print("-" * 20)

# æ”¶ç›Šç‡æ˜¯é‡‘èåˆ†æçš„æ ¸å¿ƒæ¦‚å¿µ
# è¡¡é‡æŠ•èµ„çš„ç›¸å¯¹æ”¶ç›Šï¼Œæ¶ˆé™¤äº†ä»·æ ¼æ°´å¹³çš„å½±å“

# ç”Ÿæˆç¤ºä¾‹ä»·æ ¼æ•°æ®ç”¨äºæ”¶ç›Šç‡æ¼”ç¤º
prices = pd.Series(
    [100, 105, 110, 108, 115], index=pd.date_range("2025-01-01", periods=5),
)
print("ç¤ºä¾‹ä»·æ ¼æ•°æ®ï¼š")
print(prices)

print("\n2. å•æœŸæ”¶ç›Šç‡è®¡ç®—")
print("-" * 20)

# ç™¾åˆ†æ¯”å˜åŒ–ç‡ - pct_change() è®¡ç®—ç›¸é‚»æœŸé—´çš„å˜åŒ–ç‡
# å…¬å¼ï¼šreturn_t = (price_t - price_{t-1}) / price_{t-1}
# è¿™æ˜¯é‡‘èä¸­æœ€åŸºæœ¬çš„æ”¶ç›Šç‡è®¡ç®—æ–¹æ³•

# å•æœŸæ”¶ç›Šç‡è®¡ç®— - é»˜è®¤ periods=1ï¼Œè®¡ç®—ç›¸é‚»æœŸé—´æ”¶ç›Šç‡
# å…¬å¼ï¼šR_t = (P_t - P_{t-1}) / P_{t-1}
# é‡‘èæ„ä¹‰ï¼šè¡¡é‡æŠ•èµ„åœ¨å•ä½æ—¶é—´å†…çš„ç›¸å¯¹æ”¶ç›Š
returns = prices.pct_change(fill_method=None)  # é»˜è®¤è®¡ç®—å•æ—¥æ”¶ç›Šç‡
print("å•æ—¥æ”¶ç›Šç‡ï¼š")
print(returns)

# è§£é‡Šç»“æœï¼š
# ç¬¬ä¸€å¤©ï¼šNaNï¼ˆæ²¡æœ‰å‰ä¸€å¤©æ•°æ®ï¼‰
# ç¬¬äºŒå¤©ï¼š(105-100)/100 = 0.05 = 5%
# ç¬¬ä¸‰å¤©ï¼š(110-105)/105 = 0.047619 â‰ˆ 4.76%
# ç¬¬å››å¤©ï¼š(108-110)/110 = -0.018182 â‰ˆ -1.82%
# ç¬¬äº”å¤©ï¼š(115-108)/108 = 0.064815 â‰ˆ 6.48%

print("\n3. å¤šæœŸæ”¶ç›Šç‡è®¡ç®—")
print("-" * 20)

# å¤šæœŸæ”¶ç›Šç‡è®¡ç®— - periods=3 è¡¨ç¤ºè®¡ç®— 3 æœŸé—´éš”çš„æ”¶ç›Šç‡
# å…¬å¼ï¼šR_t = (P_t - P_{t-3}) / P_{t-3}
# é‡‘èæ„ä¹‰ï¼šè¡¡é‡è¾ƒé•¿æ—¶é—´è·¨åº¦çš„ç´¯ç§¯æ”¶ç›Šï¼Œå¸¸ç”¨äºè¶‹åŠ¿åˆ†æ
long_returns = prices.pct_change(periods=3, fill_method=None)
print("3æ—¥æ”¶ç›Šç‡ï¼š")
print(long_returns)

# è§£é‡Šç»“æœï¼š
# å‰3å¤©ï¼šNaNï¼ˆæ•°æ®ä¸è¶³ï¼‰
# ç¬¬4å¤©ï¼š(108-100)/100 = 0.08 = 8%ï¼ˆ3å¤©ç´¯è®¡æ¶¨8%ï¼‰
# ç¬¬5å¤©ï¼š(115-105)/105 = 0.095238 â‰ˆ 9.52%ï¼ˆ3å¤©ç´¯è®¡æ¶¨9.52%ï¼‰

print("\n4. å¤„ç†æ”¶ç›Šç‡æ•°æ®")
print("-" * 20)

# æ¸…ç†ç¼ºå¤±å€¼ - pct_change() ç¬¬ä¸€ä¸ªå€¼ä¸º NaNï¼ˆæ— å‰æœŸæ•°æ®å¯¹æ¯”ï¼‰
clean_returns = returns.dropna()
print("æ¸…ç†åçš„æ”¶ç›Šç‡ï¼š")
print(clean_returns)

# æ”¶ç›Šç‡ç»Ÿè®¡åˆ†æ
print("\næ”¶ç›Šç‡ç»Ÿè®¡åˆ†æï¼š")
print(f"å¹³å‡æ”¶ç›Šç‡ï¼š{clean_returns.mean():.4f}")
print(f"æ”¶ç›Šç‡æ ‡å‡†å·®ï¼ˆæ³¢åŠ¨ç‡ï¼‰ï¼š{clean_returns.std():.4f}")
print(f"æœ€å¤§æ”¶ç›Šç‡ï¼š{clean_returns.max():.4f}")
print(f"æœ€å°æ”¶ç›Šç‡ï¼š{clean_returns.min():.4f}")

# --------------------------- ç¬¬ä¹éƒ¨åˆ†ï¼šæŠ€æœ¯æŒ‡æ ‡è®¡ç®— ---------------------------

print("\n" + "=" * 60)
print("ç¬¬ä¹éƒ¨åˆ†ï¼šæŠ€æœ¯æŒ‡æ ‡è®¡ç®—")
print("=" * 60)

print("\n1. ç§»åŠ¨å¹³å‡çº¿")
print("-" * 15)

# é‡æ–°åˆ›å»ºä»·æ ¼æ•°æ®ç”¨äºæŠ€æœ¯åˆ†æ
np.random.seed(42)
# æ¨¡æ‹Ÿè‚¡ä»·æ•°æ®ï¼šèµ·å§‹ä»·æ ¼100ï¼Œéšæœºæ³¢åŠ¨
stock_price = 100 * np.cumprod(1 + np.random.normal(0.001, 0.02, 100))
stock_series = pd.Series(stock_price, index=pd.date_range("2025-01-01", periods=100))

print("è‚¡ä»·æ•°æ®ï¼ˆå‰10å¤©ï¼‰ï¼š")
print(stock_series.head(10))

# ç§»åŠ¨å¹³å‡çº¿ï¼ˆMAï¼‰- æŠ€æœ¯åˆ†æä¸­çš„è¶‹åŠ¿æŒ‡æ ‡
# è®¡ç®—ä¸åŒå‘¨æœŸçš„ç§»åŠ¨å¹³å‡çº¿

# çŸ­æœŸç§»åŠ¨å¹³å‡ï¼ˆ5æ—¥ï¼‰
ma_5 = stock_series.rolling(5).mean()
print("\n5æ—¥ç§»åŠ¨å¹³å‡ï¼ˆå‰10ä¸ªï¼‰ï¼š")
print(ma_5.head(10))

# ä¸­æœŸç§»åŠ¨å¹³å‡ï¼ˆ20æ—¥ï¼‰
# 20æ—¥ç§»åŠ¨å¹³å‡å…¬å¼ï¼šMA20_t = (P_t + P_{t-1} + ... + P_{t-19}) / 20
# é‡‘èæ„ä¹‰ï¼šå¹³æ»‘ä»·æ ¼æ³¢åŠ¨ï¼Œè¯†åˆ«è¶‹åŠ¿æ–¹å‘ï¼Œæ”¯æ’‘/é˜»åŠ›ä½åˆ¤æ–­
ma_20 = stock_series.rolling(20).mean()

# é•¿æœŸç§»åŠ¨å¹³å‡ï¼ˆ50æ—¥ï¼‰
ma_50 = stock_series.rolling(50).mean()

print("ç§»åŠ¨å¹³å‡çº¿å¯¹æ¯”ï¼ˆç¬¬50å¤©ï¼‰ï¼š")
print(f"è‚¡ä»·ï¼š{stock_series.iloc[49]:.2f}")
print(f"5æ—¥å‡çº¿ï¼š{ma_5.iloc[49]:.2f}")
print(f"20æ—¥å‡çº¿ï¼š{ma_20.iloc[49]:.2f}")
print(f"50æ—¥å‡çº¿ï¼š{ma_50.iloc[49]:.2f}")

print("\n2. æ³¢åŠ¨ç‡æŒ‡æ ‡")
print("-" * 15)

# æ»šåŠ¨æ ‡å‡†å·® - è¡¡é‡ä»·æ ¼æ³¢åŠ¨æ€§çš„æŒ‡æ ‡
# å…¬å¼ï¼šÏƒ_20 = sqrt(Î£(P_i - MA20)Â² / 19)ï¼Œi ä» t-19 åˆ° t
# é‡‘èæ„ä¹‰ï¼šæ³¢åŠ¨ç‡æŒ‡æ ‡ï¼Œç”¨äºé£é™©åº¦é‡å’Œå¸ƒæ—å¸¦è®¡ç®—
volatility_20 = stock_series.rolling(20).std()
print("20æ—¥æ³¢åŠ¨ç‡ï¼ˆå‰25ä¸ªï¼Œä»ç¬¬20ä¸ªå¼€å§‹æœ‰æ•ˆï¼‰ï¼š")
print(volatility_20.iloc[19:25])

# å¹´åŒ–æ³¢åŠ¨ç‡ï¼ˆå‡è®¾ä¸€å¹´252ä¸ªäº¤æ˜“æ—¥ï¼‰
annualized_volatility = volatility_20 * np.sqrt(252)
print("å¹´åŒ–æ³¢åŠ¨ç‡ï¼š")
print(annualized_volatility.iloc[19:25])

print("\n3. è‡ªå®šä¹‰æŠ€æœ¯æŒ‡æ ‡")
print("-" * 20)


# è‡ªå®šä¹‰æ»šåŠ¨å‡½æ•° - apply() å…è®¸åº”ç”¨è‡ªå®šä¹‰çš„èšåˆå‡½æ•°
def price_range(x):
    """è‡ªå®šä¹‰æ»šåŠ¨å‡½æ•°ï¼šè®¡ç®—çª—å£å†…çš„ä»·æ ¼æ³¢åŠ¨å¹…åº¦

    å…¬å¼ï¼š(max - min) / å½“å‰ä»·æ ¼ * 100
    é‡‘èæ„ä¹‰ï¼šè¡¡é‡æŒ‡å®šæ—¶é—´çª—å£å†…çš„ä»·æ ¼æ³¢åŠ¨èŒƒå›´ï¼Œ
    ç±»ä¼¼äºæŠ€æœ¯åˆ†æä¸­çš„çœŸå®æ³¢åŠ¨å¹…åº¦ï¼ˆATRï¼‰çš„ç®€åŒ–ç‰ˆæœ¬
    """
    if len(x) == 0:
        return np.nan
    return (x.max() - x.min()) / x.iloc[-1] * 100


# åº”ç”¨è‡ªå®šä¹‰å‡½æ•°åˆ° 10 æœŸæ»šåŠ¨çª—å£
# é‡‘èæ„ä¹‰ï¼šæ¯ä¸ªæ—¶ç‚¹éƒ½èƒ½å¾—åˆ°è¿‡å» 10 æœŸçš„ä»·æ ¼æ³¢åŠ¨å¹…åº¦
custom_indicator = stock_series.rolling(10).apply(price_range)
print("è‡ªå®šä¹‰æ³¢åŠ¨å¹…åº¦æŒ‡æ ‡ï¼ˆ%ï¼‰ï¼š")
print(custom_indicator.dropna().head(10))

# --------------------------- ç¬¬åéƒ¨åˆ†ï¼šå®æˆ˜æ¡ˆä¾‹ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬åéƒ¨åˆ†ï¼šåŒå‡çº¿äº¤æ˜“ç³»ç»Ÿå®æˆ˜æ¡ˆä¾‹")
print("=" * 60)

print("\n1. æ•°æ®å‡†å¤‡")
print("-" * 15)

# å®æˆ˜æ¡ˆä¾‹ï¼šæ„å»ºåŒå‡çº¿äº¤æ˜“ç³»ç»Ÿ
# è·å–æ•°æ®ï¼ˆç¤ºä¾‹ä½¿ç”¨éšæœºæ¸¸èµ°æ¨¡æ‹Ÿè‚¡ä»·ï¼‰
dates = pd.date_range("2025-01-01", periods=100, freq="D")

# ä½¿ç”¨å‡ ä½•å¸ƒæœ—è¿åŠ¨æ¨¡æ‹Ÿè‚¡ä»·èµ°åŠ¿
# å…¬å¼ï¼šS_t = S_{t-1} * (1 + Î¼*dt + Ïƒ*dW_t)
# å…¶ä¸­ Î¼ ä¸ºæ¼‚ç§»ç‡ï¼ŒÏƒ ä¸ºæ³¢åŠ¨ç‡ï¼ŒdW_t ä¸ºéšæœºæ‰°åŠ¨
np.random.seed(42)
prices_df = pd.DataFrame(
    {
        # AAPLï¼šæ—¥å‡æ”¶ç›Š 0.1%ï¼Œå¹´åŒ–æ³¢åŠ¨ç‡çº¦ 32%
        "AAPL": 150 * np.cumprod(1 + np.random.normal(0.001, 0.02, 100)),
        # GOOGï¼šæ—¥å‡æ”¶ç›Š 0.08%ï¼Œå¹´åŒ–æ³¢åŠ¨ç‡çº¦ 24%
        "GOOG": 2800 * np.cumprod(1 + np.random.normal(0.0008, 0.015, 100)),
    },
    index=dates,
)

print("æ¨¡æ‹Ÿè‚¡ä»·æ•°æ®ï¼ˆå‰5å¤©ï¼‰ï¼š")
print(prices_df.head())

print("\n2. æ”¶ç›Šç‡åˆ†æ")
print("-" * 15)

# è®¡ç®— 5 æ—¥æ”¶ç›Šç‡ - ç”¨äºåŠ¨é‡ç­–ç•¥åˆ†æ
# å…¬å¼ï¼šR_5d = (P_t - P_{t-5}) / P_{t-5}
# é‡‘èæ„ä¹‰ï¼šçŸ­æœŸåŠ¨é‡æŒ‡æ ‡ï¼Œæ­£å€¼è¡¨ç¤ºä¸Šæ¶¨è¶‹åŠ¿ï¼Œè´Ÿå€¼è¡¨ç¤ºä¸‹è·Œè¶‹åŠ¿
returns_5d = prices_df.pct_change(5, fill_method=None).dropna()
print("5æ—¥æ”¶ç›Šç‡ï¼ˆå‰5ä¸ªæœ‰æ•ˆå€¼ï¼‰ï¼š")
print(returns_5d.head())

print("æ”¶ç›Šç‡ç»Ÿè®¡æ‘˜è¦ï¼š")
print(returns_5d.describe())

print("\n3. åŒå‡çº¿ç³»ç»Ÿæ„å»º")
print("-" * 20)

# åŒå‡çº¿ç³»ç»Ÿæ„å»º - ç»å…¸çš„è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥
# çŸ­æœŸå‡çº¿ï¼ˆ20æ—¥ï¼‰ï¼šMA20 = Î£(P_i) / 20ï¼Œi ä» t-19 åˆ° t
# é•¿æœŸå‡çº¿ï¼ˆ60æ—¥ï¼‰ï¼šMA60 = Î£(P_i) / 60ï¼Œi ä» t-59 åˆ° t

print("è®¡ç®—AAPLçš„åŒå‡çº¿ç³»ç»Ÿ...")
prices_df["AAPL_MA20"] = prices_df["AAPL"].rolling(20).mean()
prices_df["AAPL_MA60"] = prices_df["AAPL"].rolling(60).mean()

# æ˜¾ç¤ºç³»ç»Ÿæ•°æ®ï¼ˆå»æ‰NaNï¼‰
system_data = prices_df[["AAPL", "AAPL_MA20", "AAPL_MA60"]].dropna()
print("åŒå‡çº¿ç³»ç»Ÿæ•°æ®ï¼ˆå‰5ä¸ªæœ‰æ•ˆå€¼ï¼‰ï¼š")
print(system_data.head())

print("\n4. äº¤æ˜“ä¿¡å·ç”Ÿæˆ")
print("-" * 20)

# åŒå‡çº¿äº¤æ˜“ä¿¡å·é€»è¾‘ï¼š
# é‡‘å‰ï¼ˆGolden Crossï¼‰ï¼šçŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿ â†’ ä¹°å…¥ä¿¡å·
# æ­»å‰ï¼ˆDeath Crossï¼‰ï¼šçŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿ â†’ å–å‡ºä¿¡å·
# ç†è®ºåŸºç¡€ï¼šè¶‹åŠ¿è·Ÿè¸ªï¼Œå‡è®¾ä»·æ ¼è¶‹åŠ¿å…·æœ‰æŒç»­æ€§

# åˆ›å»ºäº¤æ˜“ä¿¡å·
system_data["Signal"] = 0  # åˆå§‹åŒ–ä¿¡å·åˆ—
# å½“çŸ­æœŸå‡çº¿é«˜äºé•¿æœŸå‡çº¿æ—¶ä¸º1ï¼ˆçœ‹æ¶¨ï¼‰ï¼Œå¦åˆ™ä¸º-1ï¼ˆçœ‹è·Œï¼‰
system_data.loc[system_data["AAPL_MA20"] > system_data["AAPL_MA60"], "Signal"] = 1
system_data.loc[system_data["AAPL_MA20"] <= system_data["AAPL_MA60"], "Signal"] = -1

# æ£€æµ‹ä¿¡å·å˜åŒ–ï¼ˆäº¤å‰ç‚¹ï¼‰
system_data["Position_Change"] = system_data["Signal"].diff()
# Position_Change = 2 è¡¨ç¤ºä»-1å˜ä¸º1ï¼ˆé‡‘å‰ï¼Œä¹°å…¥ï¼‰
# Position_Change = -2 è¡¨ç¤ºä»1å˜ä¸º-1ï¼ˆæ­»å‰ï¼Œå–å‡ºï¼‰

golden_crosses = system_data[system_data["Position_Change"] == 2]
death_crosses = system_data[system_data["Position_Change"] == -2]

print(f"é‡‘å‰æ¬¡æ•°ï¼š{len(golden_crosses)}")
print(f"æ­»å‰æ¬¡æ•°ï¼š{len(death_crosses)}")

if len(golden_crosses) > 0:
    print("æœ€è¿‘ä¸€æ¬¡é‡‘å‰ï¼š")
    print(golden_crosses.tail(1)[["AAPL", "AAPL_MA20", "AAPL_MA60"]])

if len(death_crosses) > 0:
    print("æœ€è¿‘ä¸€æ¬¡æ­»å‰ï¼š")
    print(death_crosses.tail(1)[["AAPL", "AAPL_MA20", "AAPL_MA60"]])

print("\n5. ç­–ç•¥å›æµ‹")
print("-" * 15)

# ç®€å•çš„ç­–ç•¥å›æµ‹
# å‡è®¾åœ¨é‡‘å‰æ—¶ä¹°å…¥ï¼Œæ­»å‰æ—¶å–å‡º
system_data["Returns"] = system_data["AAPL"].pct_change()
system_data["Strategy_Returns"] = (
    system_data["Signal"].shift(1) * system_data["Returns"]
)

# ç´¯ç§¯æ”¶ç›Šè®¡ç®—
system_data["Cumulative_Returns"] = (1 + system_data["Returns"]).cumprod()
system_data["Strategy_Cumulative"] = (1 + system_data["Strategy_Returns"]).cumprod()

final_data = system_data.dropna()
if len(final_data) > 0:
    print("ç­–ç•¥è¡¨ç°æ‘˜è¦ï¼š")
    print(
        f"ä¹°å…¥æŒæœ‰ç­–ç•¥ç´¯è®¡æ”¶ç›Šï¼š{(final_data['Cumulative_Returns'].iloc[-1] - 1) * 100:.2f}%",
    )
    print(
        f"åŒå‡çº¿ç­–ç•¥ç´¯è®¡æ”¶ç›Šï¼š{(final_data['Strategy_Cumulative'].iloc[-1] - 1) * 100:.2f}%",
    )
    print(
        f"ç­–ç•¥å¹´åŒ–æ³¢åŠ¨ç‡ï¼š{final_data['Strategy_Returns'].std() * np.sqrt(252) * 100:.2f}%",
    )

# å¯è§†åŒ–åŒå‡çº¿ç³»ç»Ÿï¼ˆå¦‚æœéœ€è¦æ˜¾ç¤ºå›¾è¡¨ï¼Œå–æ¶ˆæ³¨é‡Šï¼‰
# plt.figure(figsize=(12, 8))
# system_data[["AAPL", "AAPL_MA20", "AAPL_MA60"]].plot(figsize=(12, 6))
# plt.title("è‹¹æœè‚¡ä»·åŒå‡çº¿ç³»ç»Ÿ")
# plt.ylabel("ä»·æ ¼")
# plt.legend(["è‚¡ä»·", "20æ—¥å‡çº¿", "60æ—¥å‡çº¿"])
# plt.grid(True)
# plt.show()

# --------------------------- ç¬¬åä¸€éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ ---------------------------

print("\n" + "=" * 60)
print("ç¬¬åä¸€éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ")
print("=" * 60)

print("\n1. æ•°æ®ç±»å‹å¤„ç†")
print("-" * 20)

# å¸¸è§é—®é¢˜1ï¼šæ•°æ®ç±»å‹ä¸åŒ¹é…
sample_df = pd.DataFrame(
    {
        "price": ["100.5", "101.2", "99.8"],  # å­—ç¬¦ä¸²ç±»å‹
        "volume": [1000, 1500, 800],
    },
)

print("åŸå§‹æ•°æ®ç±»å‹ï¼š")
print(sample_df.dtypes)

# è§£å†³æ–¹æ¡ˆï¼šè½¬æ¢æ•°æ®ç±»å‹
sample_df["price"] = pd.to_numeric(sample_df["price"])
print("è½¬æ¢åæ•°æ®ç±»å‹ï¼š")
print(sample_df.dtypes)

print("\n2. å†…å­˜ä¼˜åŒ–")
print("-" * 15)

# å¤§æ•°æ®é›†çš„å†…å­˜ä¼˜åŒ–
print("ä¼˜åŒ–å‰å†…å­˜ä½¿ç”¨ï¼š")
print(f"DataFrameå†…å­˜ä½¿ç”¨ï¼š{sample_df.memory_usage(deep=True).sum()} bytes")

# ä½¿ç”¨æ›´å°çš„æ•°æ®ç±»å‹
sample_df["volume"] = sample_df["volume"].astype("int32")  # é»˜è®¤æ˜¯int64
print("ä¼˜åŒ–åå†…å­˜ä½¿ç”¨ï¼š")
print(f"DataFrameå†…å­˜ä½¿ç”¨ï¼š{sample_df.memory_usage(deep=True).sum()} bytes")

print("\n3. é“¾å¼æ“ä½œæœ€ä½³å®è·µ")
print("-" * 25)

# æ¨èçš„é“¾å¼æ“ä½œå†™æ³•
result = (
    sample_df.assign(price_change=lambda x: x["price"].pct_change())
    .dropna()
    .query("volume > 1000")
    .reset_index(drop=True)
)

print("é“¾å¼æ“ä½œç»“æœï¼š")
print(result)

print("\n4. å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ")
print("-" * 25)

print("é”™è¯¯1ï¼šSettingWithCopyWarning")
print("åŸå› ï¼šå¯¹DataFrameåˆ‡ç‰‡åç›´æ¥èµ‹å€¼")
print("è§£å†³ï¼šä½¿ç”¨.loc[]æˆ–.copy()")

print("\né”™è¯¯2ï¼šæ—¥æœŸç´¢å¼•æ—¶åŒºé—®é¢˜")
print("åŸå› ï¼šæ··åˆä½¿ç”¨æœ‰æ—¶åŒºå’Œæ— æ—¶åŒºçš„æ—¥æœŸ")
print("è§£å†³ï¼šç»Ÿä¸€æ—¶åŒºå¤„ç†")

print("\né”™è¯¯3ï¼šæ»šåŠ¨çª—å£è®¡ç®—ç»“æœå…¨ä¸ºNaN")
print("åŸå› ï¼šçª—å£å¤§å°è¶…è¿‡æ•°æ®é•¿åº¦")
print("è§£å†³ï¼šä½¿ç”¨min_periodså‚æ•°æˆ–æ£€æŸ¥æ•°æ®é•¿åº¦")

# --------------------------- æ€»ç»“å’Œå­¦ä¹ å»ºè®® ---------------------------

print("\n" + "=" * 60)
print("æ€»ç»“å’Œå­¦ä¹ å»ºè®®")
print("=" * 60)

print("\næœ¬æ•™ç¨‹æ¶µç›–çš„æ ¸å¿ƒæ¦‚å¿µï¼š")
print("1. âœ… Serieså’ŒDataFrameåŸºç¡€æ“ä½œ")
print("2. âœ… ç´¢å¼•å’Œæ•°æ®é€‰æ‹©ï¼ˆilocã€locï¼‰")
print("3. âœ… ç¼ºå¤±å€¼å¤„ç†ï¼ˆfillnaã€dropnaï¼‰")
print("4. âœ… æ—¶é—´åºåˆ—æ“ä½œï¼ˆé‡é‡‡æ ·ã€æ—¶åŒºï¼‰")
print("5. âœ… æ»šåŠ¨çª—å£è®¡ç®—ï¼ˆç§»åŠ¨å¹³å‡ã€æ³¢åŠ¨ç‡ï¼‰")
print("6. âœ… æ”¶ç›Šç‡è®¡ç®—å’Œé‡‘èæŒ‡æ ‡")
print("7. âœ… å®æˆ˜æ¡ˆä¾‹ï¼ˆåŒå‡çº¿äº¤æ˜“ç³»ç»Ÿï¼‰")

print("\nä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®ï¼š")
print("1. ğŸ“š æ·±å…¥å­¦ä¹ pandasçš„groupbyæ“ä½œ")
print("2. ğŸ“Š å­¦ä¹ æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ï¼ˆRSIã€MACDã€å¸ƒæ—å¸¦ï¼‰")
print("3. ğŸ” æŒæ¡æ•°æ®æ¸…æ´—å’Œå¼‚å¸¸å€¼å¤„ç†")
print("4. ğŸ“ˆ å­¦ä¹ å¯è§†åŒ–åº“ï¼ˆmatplotlibã€seabornã€plotlyï¼‰")
print("5. ğŸš€ å­¦ä¹ æ›´é«˜çº§çš„é‡‘èåˆ†æï¼ˆæŠ•èµ„ç»„åˆä¼˜åŒ–ã€é£é™©æ¨¡å‹ï¼‰")

print("\nå®ç”¨èµ„æºï¼š")
print("- å®˜æ–¹æ–‡æ¡£ï¼šhttps://pandas.pydata.org/docs/")
print("- é‡‘èæ•°æ®æºï¼šyfinance, quandl, alpha_vantage")
print("- å›æµ‹æ¡†æ¶ï¼šbacktrader, zipline, vectorbt")

print("\n" + "=" * 60)
print("æ•™ç¨‹å®Œæˆï¼å¸Œæœ›è¿™äº›è¯¦ç»†æ³¨é‡Šèƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£pandasåœ¨é‡‘èåˆ†æä¸­çš„åº”ç”¨ã€‚")
print("è®°ä½ï¼šå®è·µæ˜¯æœ€å¥½çš„è€å¸ˆï¼Œå¤šåŠ¨æ‰‹å°è¯•å„ç§æ•°æ®æ“ä½œï¼")
print("=" * 60)
